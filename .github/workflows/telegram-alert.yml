name: Telegram Alert on Downtime

on:
  schedule:
    - cron: "*/5 * * * *"  # –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
  workflow_dispatch:

jobs:
  check-status:
    name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏ –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–∞–π—Ç–æ–≤
        id: check-sites
        run: |
          summary_file=".upptime/summary.json"
          if [ ! -f "$summary_file" ]; then
            echo "down_sites=" >> $GITHUB_OUTPUT
            exit 0
          fi

          down_sites=$(jq -r '.sites[] | select(.status != "up") | "- \(.name): \(.url)"' $summary_file | tr '\n' '\n')
          echo "down_sites=$down_sites" >> $GITHUB_OUTPUT

      - name: –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
        if: ${{ steps.check-sites.outputs.down_sites != '' }}
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            üö® –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å —Å–∞–π—Ç–∞–º–∏:
            ${{ steps.check-sites.outputs.down_sites }}

            üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
